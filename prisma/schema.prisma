generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  walletAddress   String   @unique
  twitterId       String?  @unique // Twitter user ID
  twitterUsername String?  // Twitter handle (@username)
  // API key for programmatic access (hash stored, never plaintext)
  apiKeyHash      String?  // bcrypt hash of the API key
  apiKeyPrefix    String?  // First 8 chars for identification (e.g., "svk_abc1...")
  apiKeyCreatedAt DateTime? // When the API key was generated
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  managedSwarms SwarmManager[]
  memberships   SwarmMembership[]
}

model Swarm {
  id              String   @id @default(uuid())
  name            String
  description     String
  litPkpPublicKey String
  litPkpTokenId   String
  litPkpEthAddress String  // ETH address derived from PKP public key
  // Visibility and invite settings
  isPublic        Boolean  @default(false) // Whether swarm is publicly discoverable
  inviteCode      String?  @unique          // Unique code for joining private swarms
  // Gnosis SAFE integration for multi-sig approval
  safeAddress       String?  // Gnosis SAFE address for sign-off
  requireSafeSignoff Boolean @default(false) // Whether manager actions require SAFE approval
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  managers     SwarmManager[]
  memberships  SwarmMembership[]
  transactions Transaction[]
  proposals    ProposedAction[]
}

model SwarmManager {
  id        String   @id @default(uuid())
  swarmId   String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  swarm Swarm @relation(fields: [swarmId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([swarmId, userId])
}

enum MembershipStatus {
  ACTIVE
  LEFT
}

model SwarmMembership {
  id                 String           @id @default(uuid())
  swarmId            String
  userId             String
  agentWalletAddress String
  sessionKeyApproval String?          @db.Text // Serialized permission account for PKP signing
  status             MembershipStatus @default(ACTIVE)
  joinedAt           DateTime         @default(now())

  // Relations
  swarm              Swarm               @relation(fields: [swarmId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionTargets TransactionTarget[]

  @@unique([swarmId, userId])
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Transaction {
  id        String            @id @default(uuid())
  swarmId   String
  status    TransactionStatus @default(PENDING)
  template  Json
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // Relations
  swarm   Swarm               @relation(fields: [swarmId], references: [id], onDelete: Cascade)
  targets TransactionTarget[]
}

enum TransactionTargetStatus {
  PENDING
  SUBMITTED
  CONFIRMED
  FAILED
}

model TransactionTarget {
  id             String                  @id @default(uuid())
  transactionId  String
  membershipId   String
  resolvedTxData Json
  userOpHash     String?
  txHash         String?
  status         TransactionTargetStatus @default(PENDING)
  error          String?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  // Relations
  transaction Transaction     @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  membership  SwarmMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
}

// Proposed action status for SAFE sign-off flow
enum ProposedActionStatus {
  PROPOSED   // Waiting for SAFE signature
  APPROVED   // SAFE has signed, ready to execute
  REJECTED   // Proposal was rejected or cancelled
  EXECUTED   // Proposal was executed
  EXPIRED    // Proposal expired before execution
}

enum ProposedActionType {
  SWAP         // Token swap
  TRANSACTION  // Generic transaction template
}

model ProposedAction {
  id              String              @id @default(uuid())
  swarmId         String
  managerId       String              // User who proposed the action
  actionType      ProposedActionType
  actionData      Json                // JSON with action details (swap params or tx template)
  safeMessageHash String              // Hash for SAFE to sign (EIP-712)
  status          ProposedActionStatus @default(PROPOSED)
  proposedAt      DateTime            @default(now())
  approvedAt      DateTime?           // When SAFE signed
  executedAt      DateTime?           // When action was executed
  expiresAt       DateTime            // Proposal expiration time
  executionTxId   String?             // Link to Transaction record after execution

  // Relations
  swarm Swarm @relation(fields: [swarmId], references: [id], onDelete: Cascade)
}
